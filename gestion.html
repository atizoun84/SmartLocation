<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartLocation ‚Äì Saisie des paiements</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#003366">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/609/609803.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f0f2f5;
      font-family: 'Segoe UI', sans-serif;
      padding-top: 70px;
    }
    h2 {
      color: #003366;
      font-weight: 600;
    }
    .form-label {
      font-weight: 500;
      color: #003366;
    }
    .btn-primary {
      background-color: #003366;
      border: none;
    }
    .btn-primary:hover {
      background-color: #00509e;
    }
    .navbar {
      background-color: #003366;
    }
    .navbar-brand, .nav-link {
      color: white !important;
    }
    .nav-link:hover {
      text-decoration: underline;
    }
    .navbar-date {
      color: #ffcc00;
      font-weight: bold;
      font-size: 0.9rem;
    }
    footer {
      margin-top: 40px;
      font-size: 0.9em;
      text-align: center;
      color: #666;
    }
    #historiqueSection {
      display: none; 
    }
    .table-responsive {
        overflow-x: auto;
    }
    .input-group-append button {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
    .info-recuperee {
        color: #0099ff !important;
        font-weight: bold !important;
        font-family: 'Tahoma', sans-serif !important;
    }
    #montantCumulePaye {
        color: #0d6efd !important;
        font-weight: bold !important;
    }
    #montantRetards {
        color: #dc3545 !important;
        font-weight: bold !important;
    }
    .facture-box-whatsapp {
        white-space: pre-wrap;
        font-family: monospace;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        color: #212529;
        max-height: 70vh;
        overflow-y: auto;
    }

    /* MODIFICATION : LOGIQUE D'IMPRESSION ET MISE EN FORME */
    @media print {
        /* Masquer tout sauf la zone d'impression */
        body > * {
            display: none !important;
        }
        #printArea {
            display: block !important;
            visibility: visible !important;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            padding: 10px;
            background: white;
            font-size: 10pt !important; /* Taille de police r√©duite */
        }
        #printArea * {
            display: block; /* Force l'affichage */
            visibility: visible !important;
        }
        /* Correction du tableau pour l'impression */
        #printArea table {
            width: 100% !important;
            border-collapse: collapse !important;
            display: table !important; /* Force le comportement de tableau */
        }
        #printArea thead { display: table-header-group !important; }
        #printArea tbody { display: table-row-group !important; }
        #printArea tr { display: table-row !important; page-break-inside: avoid; }
        #printArea th, #printArea td { 
            display: table-cell !important; 
            padding: 5px !important;
            font-size: 9pt !important;
        }
        .table-secondary {
            background-color: #e2e3e5 !important;
            -webkit-print-color-adjust: exact;
        }
        .table-dark th {
            background-color: #003366 !important;
            color: white !important;
            -webkit-print-color-adjust: exact;
        }
        .row { display: flex !important; flex-wrap: nowrap !important; }
        .col-6 { width: 50% !important; }
        .text-end { text-align: right !important; }
    }
    
    .signature-img {
      max-width: 150px;
      max-height: 80px;
      display: block;
      margin: 5px auto;
    }
    #zoneAvancesDisponibles {
      background-color: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 8px;
    }
    #printArea { display: none; } /* Cach√© √† l'√©cran */
  </style>
</head>
<body>

  <div id="printArea"></div>

  <nav class="navbar fixed-top navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">SmartLocation <span id="navbarDate" class="ms-3 navbar-date"></span></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon bg-light"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Tableau de bord</a></li>
          <li class="nav-item"><a class="nav-link" href="config.html">Configuration</a></li>
          <li class="nav-item"><a class="nav-link active" href="gestion.html">Saisie des paiements</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <h2 class="text-center mb-4">üí≥ Gestion des Paiements</h2>

    <div class="mb-4">
      <label class="form-label">üè¢ S√©lectionner un appartement</label>
      <select id="selectAppartement" class="form-select"></select>
    </div>

    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <label for="nomProprietaireAffichage" class="form-label">üë§ Nom du Propri√©taire</label>
            <input type="text" id="nomProprietaireAffichage" class="form-control info-recuperee" readonly />
        </div>
        <div class="col-md-4 mb-3">
            <label for="contactProprietaireAffichage" class="form-label">üìû Contact Propri√©taire</label>
            <input type="text" id="contactProprietaireAffichage" class="form-control info-recuperee" readonly />
        </div>
        <div class="col-md-4 mb-3">
            <label for="coutMensuelAffichage" class="form-label">üí∞ Co√ªt Mensuel (FCFA)</label>
            <div class="input-group">
                <input type="number" id="coutMensuelAffichage" class="form-control info-recuperee" readonly />
                <div class="input-group-append">
                    <button class="btn btn-info" type="button" id="btnModifierCout" onclick="toggleModificationCout()">Modifier</button>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="paiementIdModification" value="" /> 

    <div class="row">
        <div class="col-md-4 mb-3">
            <label class="form-label">üìÖ Mois √† payer</label>
            <select id="mois" class="form-select" multiple size="8" onchange="calculerCumul()"></select>
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">üí∞ D√©j√† Pay√© (Cumul√© FCFA)</label>
            <input type="text" id="montantCumulePaye" class="form-control" readonly />
            
            <label class="form-label mt-3">üö® Total des Retards (FCFA)</label>
            <input type="text" id="montantRetards" class="form-control" readonly />
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">üíµ Montant S√©lectionn√© (FCFA)</label>
            <input type="number" id="montant" class="form-control" readonly style="color: #006400; font-weight: bold;" />
            
            <label class="form-label mt-3">üìù Observation</label>
            <input type="text" id="observation" class="form-control" placeholder="Note ou r√©f√©rence" />
        </div>
    </div>

    <div id="zoneAvancesDisponibles" class="p-3 mb-3 d-none text-center border shadow-sm">
        <h6 class="text-primary fw-bold mb-2">üéÅ Avances disponibles d√©tect√©es !</h6>
        <p id="infoMoisAvance" class="small mb-2"></p>
        <button onclick="appliquerPaiementParAvance()" class="btn btn-primary btn-sm">Utiliser les avances pour payer</button>
    </div>

    <div class="d-grid gap-2 mb-3">
      <button onclick="validerPaiement()" class="btn btn-success" id="btnValiderPaiement">Ajouter Paiement</button>
      <div class="row g-2">
          <div class="col-12"><button onclick="ajouterAvance()" class="btn btn-outline-primary w-100">Ajouter Avance</button></div>
      </div>
      <button onclick="genererRapportGeneral()" class="btn btn-primary">üìä Rapport G√©n√©ral de Location</button>
      <button id="toggleHistoriqueBtn" class="btn btn-outline-secondary">Afficher l'historique</button>
      <button onclick="annulerModification()" class="btn btn-warning d-none" id="btnAnnulerModification">Annuler Modification</button>
    </div>

    <div class="modal fade" id="modalRapport" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title font-monospace">√âTAT FINANCIER D√âTAILL√â</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="rapportContent">
              </div>
          <div class="modal-footer no-print">
            <button class="btn btn-info" onclick="copierRapportWhatsApp()">Copier WhatsApp</button>
            <button class="btn btn-outline-dark" onclick="imprimerParIsolation()">Imprimer Rapport Professionnel</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>

    <div id="historiqueSection" class="mt-4">
      <h4 class="text-primary">üìã Historique des paiements</h4>
      <div class="table-responsive"> 
        <table class="table table-bordered table-striped">
          <thead>
            <tr><th>Appartement</th><th>Mois</th><th>Montant</th><th>Type</th><th>Observation</th><th>Actions</th></tr>
          </thead>
          <tbody id="historiquePaiements"></tbody>
        </table>
      </div>
    </div>

    <footer>
      Con√ßu par <strong>Plateny AMOUSSOU</strong> ‚Äì Professeur & Innovateur local<br />
      üìß atizoun@gmail.com | üìû 01 97 74 40 35
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const select = document.getElementById('selectAppartement');
    const historique = document.getElementById('historiquePaiements');
    const historiqueSection = document.getElementById('historiqueSection');
    const toggleHistoriqueBtn = document.getElementById('toggleHistoriqueBtn');
    const nomProprietaireAffichage = document.getElementById('nomProprietaireAffichage'); 
    const contactProprietaireAffichage = document.getElementById('contactProprietaireAffichage'); 
    const coutMensuelAffichage = document.getElementById('coutMensuelAffichage');
    const btnModifierCout = document.getElementById('btnModifierCout');
    const btnValiderPaiement = document.getElementById('btnValiderPaiement');
    const btnAnnulerModification = document.getElementById('btnAnnulerModification');
    const paiementIdModification = document.getElementById('paiementIdModification');
    const moisInput = document.getElementById('mois');
    const montantInput = document.getElementById('montant');
    const montantRetardsDisplay = document.getElementById('montantRetards');
    const montantCumulePayeDisplay = document.getElementById('montantCumulePaye');
    const observationInput = document.getElementById('observation');
    const navbarDate = document.getElementById('navbarDate');
    const modalRapport = new bootstrap.Modal(document.getElementById('modalRapport'));
    const zoneAvances = document.getElementById('zoneAvancesDisponibles');
    const infoMoisAvance = document.getElementById('infoMoisAvance');

    function mettreAJourNavbarDate() {
        const d = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        navbarDate.textContent = `| ${d.toLocaleDateString('fr-FR', options)}`;
    }

    function formaterMoisTexte(valeurMois) {
        if(!valeurMois || valeurMois.length < 7) return valeurMois;
        const parts = valeurMois.split('-');
        const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1);
        const texte = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        return texte.charAt(0).toUpperCase() + texte.slice(1);
    }

    function genererListeMois(dateIntegrationStr, indexAppartement) {
        moisInput.innerHTML = '';
        const maintenant = new Date();
        const moisActuelStr = maintenant.toISOString().slice(0, 7);
        let start;
        
        const paiementsGlobal = JSON.parse(localStorage.getItem('paiements')) || {};
        const paiementsApt = paiementsGlobal[indexAppartement] || [];
        const cout = parseFloat(coutMensuelAffichage.value) || 0;
        
        let totalRetards = 0;
        let totalDejaPaye = 0;

        if (dateIntegrationStr) {
            const parts = dateIntegrationStr.split('-');
            start = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1);
        } else {
            start = new Date(maintenant.getFullYear(), maintenant.getMonth(), 1);
        }
        
        for (let i = 0; i < 48; i++) {
            const d = new Date(start.getFullYear(), start.getMonth() + i, 1);
            const value = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
            const label = d.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }).toUpperCase();
            
            const pFound = paiementsApt.find(p => p.mois === value && p.type === 'Paiement');
            const estDansLePasse = value < moisActuelStr;
            
            const option = document.createElement('option');
            option.value = value;

            if (pFound) {
                option.textContent = `${label} (PAY√â ‚úÖ)`;
                option.style.color = "#999";
                totalDejaPaye += parseFloat(pFound.montant);
            } else if (estDansLePasse) {
                option.textContent = `${label} (RETARD ‚ö†Ô∏è)`;
                option.style.color = "#dc3545";
                option.style.fontWeight = "bold";
                totalRetards += cout;
            } else {
                option.textContent = label;
            }
            moisInput.appendChild(option);
        }
        
        const totalAvancesGlobal = paiementsApt.filter(p => p.type === 'Avance').reduce((sum, p) => sum + parseFloat(p.montant), 0);
        const totalLoyerPayeEquivalent = paiementsApt.filter(p => p.type === 'Paiement' && p.observation.includes("Pay√© via Avance")).length * cout;
        const dataApts = JSON.parse(localStorage.getItem('appartements')) || [];
        const avanceInitiale = parseFloat(dataApts[indexAppartement]?.avance) || 0;
        const soldeAvanceDisponible = (totalAvancesGlobal + avanceInitiale) - totalLoyerPayeEquivalent;
        
        totalDejaPaye += totalAvancesGlobal;

        if (soldeAvanceDisponible >= cout) {
            const nbMoisPossibles = Math.floor(soldeAvanceDisponible / cout);
            const resteAvance = soldeAvanceDisponible % cout;
            zoneAvances.classList.remove('d-none');
            infoMoisAvance.innerHTML = `Cette avance peut couvrir <strong>${nbMoisPossibles} mois</strong> de loyer.<br>Reliquat apr√®s paiement : <strong>${resteAvance.toLocaleString()} FCFA</strong>`;
        } else if (soldeAvanceDisponible > 0) {
            zoneAvances.classList.remove('d-none');
            infoMoisAvance.innerHTML = `Solde d'avance restant : <strong>${soldeAvanceDisponible.toLocaleString()} FCFA</strong> (Insuffisant pour 1 mois complet).`;
        } else {
            zoneAvances.classList.add('d-none');
        }

        montantRetardsDisplay.value = `${totalRetards.toLocaleString('fr-FR')} FCFA`;
        montantCumulePayeDisplay.value = `${totalDejaPaye.toLocaleString('fr-FR')} FCFA`;
    }

    function appliquerPaiementParAvance() {
        const cout = parseFloat(coutMensuelAffichage.value);
        const index = select.value;
        const paiementsGlobal = JSON.parse(localStorage.getItem('paiements')) || {};
        const paiementsApt = paiementsGlobal[index] || [];
        const dataApt = JSON.parse(localStorage.getItem('appartements')) || [];
        const avanceInitiale = parseFloat(dataApt[index]?.avance) || 0;
        const totalAvancesGlobal = paiementsApt.filter(p => p.type === 'Avance').reduce((sum, p) => sum + parseFloat(p.montant), 0);
        const totalLoyerPayeEquivalent = paiementsApt.filter(p => p.type === 'Paiement' && p.observation.includes("Pay√© via Avance")).length * cout;
        
        let soldeAvance = (totalAvancesGlobal + avanceInitiale) - totalLoyerPayeEquivalent;
        let moisCoches = 0;
        Array.from(moisInput.options).forEach(opt => {
            if (opt.textContent.includes('RETARD') && soldeAvance >= cout) {
                opt.selected = true;
                soldeAvance -= cout;
                moisCoches++;
            }
        });
        if (moisCoches > 0) {
            observationInput.value = "Pay√© via Avance";
            calculerCumul();
            alert(`${moisCoches} mois s√©lectionn√©s.`);
        } else {
            alert("Solde insuffisant ou aucun mois de retard trouv√©.");
        }
    }

    function calculerCumul() {
        const cout = parseFloat(coutMensuelAffichage.value) || 0;
        const nbMois = Array.from(moisInput.selectedOptions).length;
        montantInput.value = cout * nbMois;
    }

    function chargerAppartements() {
      const data = JSON.parse(localStorage.getItem('appartements')) || [];
      select.innerHTML = '';
      if (data.length === 0) {
          select.innerHTML = '<option disabled selected>Aucun appartement</option>';
          return;
      }
      data.forEach((apt, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${apt.nom} ‚Äì ${apt.locataire}`; 
        select.appendChild(option);
      });
      afficherDetailsAppartement();
    }

    function afficherDetailsAppartement() {
        const index = select.value;
        const data = JSON.parse(localStorage.getItem('appartements')) || [];
        if (data[index]) {
            const apt = data[index];
            nomProprietaireAffichage.value = apt.proprietaireNom || 'N/A';
            contactProprietaireAffichage.value = apt.proprietaireContact || 'N/A';
            coutMensuelAffichage.value = apt.cout || 0;
            genererListeMois(apt.dateEntree || apt.date, index);
            calculerCumul();
        }
    }

    function validerPaiement() {
      const index = select.value;
      const moisSelectionnes = Array.from(moisInput.selectedOptions);
      const coutUnitaire = parseFloat(coutMensuelAffichage.value);
      
      if (moisSelectionnes.length === 0) return alert("S√©lectionnez des mois.");
      
      const paiements = JSON.parse(localStorage.getItem('paiements')) || {};
      if (!paiements[index]) paiements[index] = [];
      
      moisSelectionnes.forEach(opt => {
          if (!opt.textContent.includes('PAY√â')) {
              paiements[index].push({ 
                  id: Date.now() + Math.random(), 
                  mois: opt.value, 
                  montant: coutUnitaire, 
                  type: 'Paiement', 
                  observation: observationInput.value || '', 
                  dateEnregistrement: new Date().toISOString() 
              });
          }
      });
      
      localStorage.setItem('paiements', JSON.stringify(paiements));
      alert("Paiement(s) enregistr√©(s) avec succ√®s.");
      observationInput.value = "";
      
      afficherDetailsAppartement();
      if (historiqueSection.style.display === 'block') {
          afficherHistorique();
      }
    }

    function ajouterAvance() {
        const index = select.value;
        const montantAvance = prompt("Saisir le montant de l'avance (FCFA) :");
        if (!montantAvance || isNaN(montantAvance)) return;
        const paiements = JSON.parse(localStorage.getItem('paiements')) || {};
        if (!paiements[index]) paiements[index] = [];
        paiements[index].push({ 
            id: Date.now(), mois: new Date().toISOString().slice(0, 7), montant: parseFloat(montantAvance), 
            type: 'Avance', observation: "Versement Avance", dateEnregistrement: new Date().toISOString() 
        });
        localStorage.setItem('paiements', JSON.stringify(paiements));
        
        afficherDetailsAppartement();
        if (historiqueSection.style.display === 'block') {
            afficherHistorique();
        }
    }

    function genererRapportGeneral() {
        const index = select.value;
        const appartements = JSON.parse(localStorage.getItem('appartements')) || [];
        const paiements = JSON.parse(localStorage.getItem('paiements')) || {};
        const apt = appartements[index];
        const dataPaiements = paiements[index] || [];
        if (!apt) return alert("S√©lectionnez un appartement.");

        const totalPaye = dataPaiements.reduce((sum, p) => sum + parseFloat(p.montant), 0);
        const totalRetard = parseInt(montantRetardsDisplay.value.replace(/[^0-9]/g, '')) || 0;
        
        const sigProprioImg = apt.signatureProprio ? `<img src="${apt.signatureProprio}" class="signature-img">` : '<p class="text-muted small">Non configur√©e</p>';
        const sigLocataireImg = apt.signatureLocataire ? `<img src="${apt.signatureLocataire}" class="signature-img">` : '<p class="text-muted small">Non configur√©e</p>';
        
        let lignesPaiement = "";
        if (dataPaiements.length > 0) {
            dataPaiements.sort((a, b) => b.mois.localeCompare(a.mois)).forEach(p => {
                const datePaye = p.dateEnregistrement ? new Date(p.dateEnregistrement).toLocaleDateString() : 'N/A';
                const moisTexte = p.type === 'Avance' ? "Avance" : formaterMoisTexte(p.mois);
                lignesPaiement += `<tr><td>${moisTexte}</td><td>${p.type}</td><td>${datePaye}</td><td class="text-end fw-bold">${p.montant.toLocaleString()} FCFA</td><td>${p.observation || '-'}</td></tr>`;
            });
        } else { lignesPaiement = '<tr><td colspan="5" class="text-center">Aucun paiement</td></tr>'; }
        
        const content = `
            <div style="background: white; color: black; padding: 5px;">
                <div class="text-center mb-3">
                    <h5 class="mb-0 fw-bold" style="color:#003366;">RAPPORT FINANCIER</h5>
                    <hr style="margin: 5px 0;">
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <small class="fw-bold">PROPRI√âTAIRE :</small>
                        <p class="mb-0 small">${apt.proprietaireNom}</p>
                    </div>
                    <div class="col-6 text-end">
                        <small class="fw-bold">LOCATAIRE :</small>
                        <p class="mb-0 small">${apt.locataire}</p>
                    </div>
                </div>
                <table class="table table-sm table-bordered mb-3">
                    <tr style="background-color:#eee;"><td><strong>BIEN</strong></td><td>${apt.nom}</td></tr>
                    <tr><td><strong>LOYER</strong></td><td class="fw-bold">${apt.cout.toLocaleString()} FCFA</td></tr>
                </table>
                <table class="table table-sm table-striped table-bordered mb-3" style="width:100%;">
                    <thead>
                        <tr class="table-secondary">
                            <th>Objet</th><th>Type</th><th>Date</th><th>Montant</th><th>Note</th>
                        </tr>
                    </thead>
                    <tbody>${lignesPaiement}</tbody>
                </table>
                <div class="bg-light p-2 border mb-3">
                    <div class="row text-center">
                        <div class="col-4 small"><strong>PAY√â</strong><br>${totalPaye.toLocaleString()}</div>
                        <div class="col-4 small"><strong>RETARD</strong><br>${totalRetard.toLocaleString()}</div>
                        <div class="col-4 small"><strong>DATE</strong><br>${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 text-center">
                        <small class="fw-bold">SIGN. LOCATAIRE</small><br>${sigLocataireImg}
                    </div>
                    <div class="col-6 text-center">
                        <small class="fw-bold">SIGN. PROPRIO</small><br>${sigProprioImg}
                    </div>
                </div>
            </div>`;
        
        document.getElementById('rapportContent').innerHTML = content;
        modalRapport.show();
    }

    // MODIFICATION : FONCTION ROBUSTE POUR ANDROID ET MISE EN FORME
    function imprimerParIsolation() {
        const rapportHTML = document.getElementById('rapportContent').innerHTML;
        const printArea = document.getElementById('printArea');
        
        printArea.innerHTML = rapportHTML;
        
        // Timeout pour assurer le rendu complet sur mobile avant impression
        setTimeout(() => {
            window.print();
            // Nettoyage apr√®s un l√©ger d√©lai pour que le syst√®me d'impression capture tout
            setTimeout(() => { printArea.innerHTML = ''; }, 1000);
        }, 500);
    }

    function copierRapportWhatsApp() {
        const index = select.value;
        const apt = JSON.parse(localStorage.getItem('appartements'))[index];
        const paye = montantCumulePayeDisplay.value;
        const retard = montantRetardsDisplay.value;
        const text = `*RAPPORT SMARTLOCATION*\nBien: ${apt.nom}\nLocataire: ${apt.locataire}\nPay√©: ${paye}\nRetards: ${retard}`;
        navigator.clipboard.writeText(text).then(() => alert("Copi√© !"));
    }

    function afficherHistorique() {
      const index = select.value;
      const appartements = JSON.parse(localStorage.getItem('appartements')) || [];
      const aptNom = appartements[index]?.nom || "Inconnu";
      const paiements = JSON.parse(localStorage.getItem('paiements')) || {};
      const data = paiements[index] || [];
      
      historique.innerHTML = '';
      
      if (data.length === 0) {
        historique.innerHTML = '<tr><td colspan="6" class="text-center text-muted italic">Aucun historique pour cet appartement</td></tr>';
        return;
      }

      const dataTriee = [...data].sort((a, b) => b.mois.localeCompare(a.mois));
      const paiementsSeuls = dataTriee.filter(p => p.type === 'Paiement');
      const dernierMoisValeur = paiementsSeuls.length > 0 ? paiementsSeuls[0].mois : null;

      dataTriee.forEach(p => {
        const row = document.createElement('tr');
        let moisAffiche = p.type === 'Avance' ? "Versement d'avance" : formaterMoisTexte(p.mois);
        
        if (p.type === 'Paiement' && p.mois === dernierMoisValeur) {
            moisAffiche += ' <strong class="text-success">(Dernier mois pay√©)</strong>';
        }

        row.innerHTML = `
            <td>${aptNom}</td>
            <td>${moisAffiche}</td>
            <td>${p.montant.toLocaleString()} FCFA</td>
            <td>${p.type}</td>
            <td>${p.observation}</td>
            <td><button class="btn btn-sm btn-danger" onclick="supprimerPaiement(${index}, ${p.id})">Suppr</button></td>
        `;
        historique.appendChild(row);
      });
    }

    function supprimerPaiement(idx, id) {
        if (!confirm("Voulez-vous vraiment supprimer cet enregistrement ?")) return;
        let p = JSON.parse(localStorage.getItem('paiements'));
        p[idx] = p[idx].filter(x => x.id !== id);
        localStorage.setItem('paiements', JSON.stringify(p));
        
        afficherDetailsAppartement();
        if (historiqueSection.style.display === 'block') {
            afficherHistorique();
        }
    }

    function toggleHistorique() {
      if (historiqueSection.style.display === 'none') {
        historiqueSection.style.display = 'block';
        toggleHistoriqueBtn.textContent = "Masquer l'historique";
        afficherHistorique();
      } else {
        historiqueSection.style.display = 'none';
        toggleHistoriqueBtn.textContent = "Afficher l'historique";
      }
    }

    select.addEventListener('change', () => { 
        afficherDetailsAppartement(); 
        if (historiqueSection.style.display === 'block') {
            afficherHistorique();
        }
    });

    toggleHistoriqueBtn.addEventListener('click', toggleHistorique);
    window.onload = () => { mettreAJourNavbarDate(); chargerAppartements(); };

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(registration => {
          console.log('SW registered: ', registration);
        }).catch(registrationError => {
          console.log('SW registration failed: ', registrationError);
        });
      });
    }
  </script>
</body>
</html>
